#+title: Test that check only admin can add role
#+AUTHOR: VLEAD
#+DATE: [2017-06-29 Thu]
#+SETUPFILE: ../../../../../org-templates/level-5.org
#+TAGS: boilerplate(b)
#+EXCLUDE_TAGS: boilerplate
#+OPTIONS: ^:nil

* Test
  =TestAddRole= object holds an instance of the =AddRole= component
  against the field =component=.  This test invokes the =do= method on the
  component.

** Imports
#+BEGIN_SRC python :tangle test_check_auth.py
import unittest
from runtime.objects.user.user import User
from runtime.objects.session.session import Session
from runtime.objects.email.email import Email
from runtime.objects.name.name import Name
from runtime.objects.role.role import Role
from runtime.exceptions.app.exception import AppException
from runtime.exceptions.arity.exception import ArityException
from runtime.exceptions.keymismatch.exception import KeyMismatchException
from runtime.components.guard.add_role.tests.harness import TestHarness
from runtime.datatypes.cmd.cmd import Cmd

#+END_SRC


** Test Case

   Imports the TestHarness which sets up the component. 
   This test creates an instruction with cmd =add_role=, 
   a new session with a non admin and a newly created user. 
   The guard's do method fails and raises AppException.

   Following are the steps to be taken:
    - Create a new user with user role
    - Add it to User set using entity manager
    - Create a session with this user in it and a random key
    - Add this session to the Session set using entity manager
    - Create a new user object
    - Create the instruction datatypes for =add_role= route with
      the above session and to add this newly created user
    - Call the guard's with this instruction.

The test should raise an exception with the method itself catching it.

#+BEGIN_SRC python :tangle test_check_auth.py
class TestCheckAuth(TestHarness):

    def test_check_auth(self):
        print "test_check_auth"
        session = self.session
        session = Session(user=self.d_user, role=Role.user, key="12345679")
        self.component.em.add_session(session)

        n_user = User(name=Name(val="new user"),
                    email=Email(val="n@gnu.org"),
                    roles=[Role.user])

        self.component.em.add_user(n_user)

        instr = {'cmd': Cmd.add_role, 
                 'session': session, 
                 'data': {'user': n_user,
                          'addrole': Role.admin}
        }

        guard = self.component
        with self.assertRaises(Exception):
            guard.do(instr)

#+END_SRC
